generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                String             @id @default(uuid())
  email             String             @unique
  name              String?
  password          String
  role              String             @default("user")
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  campaigns         Campaign[]
  scheduledPosts    ScheduledPost[]
  socialConnections SocialConnection[]

  @@map("users")
}

model Campaign {
  id              String             @id @default(uuid())
  name            String
  description     String?
  status          String             @default("draft")
  budget          Float?
  userId          String
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  analyses        CampaignAnalysis[]
  campaignMetrics CampaignMetric[]
  sources         CampaignSource[]
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  generatedAssets GeneratedAsset[]

  @@index([userId])
  @@index([status])
  @@map("campaigns")
}

model CampaignSource {
  id         String   @id @default(uuid())
  campaignId String
  sourceType String
  sourceUrl  String?
  sourceText String?
  metadata   Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@map("campaign_sources")
}

model CampaignAnalysis {
  id           String   @id @default(uuid())
  campaignId   String
  analysisType String
  results      Json
  summary      String?
  score        Float?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  campaign     Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([analysisType])
  @@map("campaign_analysis")
}

model GeneratedAsset {
  id             String          @id @default(uuid())
  campaignId     String
  assetType      String
  content        String?
  url            String?
  metadata       Json?
  status         String          @default("pending")
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  campaign       Campaign        @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  scheduledPosts ScheduledPost[]

  @@index([campaignId])
  @@index([assetType])
  @@index([status])
  @@map("generated_assets")
}

model Job {
  id          String    @id @default(uuid())
  type        String
  status      String    @default("pending")
  payload     Json
  result      Json?
  error       String?
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  startedAt   DateTime?
  completedAt DateTime?

  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("jobs")
}

model SocialConnection {
  id             String          @id @default(uuid())
  userId         String
  platform       String
  platformUserId String
  username       String?
  accessToken    String
  refreshToken   String?
  tokenExpiry    DateTime?
  metadata       Json?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  scheduledPosts ScheduledPost[]
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, platform])
  @@index([userId])
  @@index([platform])
  @@map("social_connections")
}

model ScheduledPost {
  id                 String           @id @default(uuid())
  userId             String
  assetId            String
  socialConnectionId String
  platform           String
  content            String
  mediaUrls          String[]
  scheduledFor       DateTime
  status             String           @default("pending")
  postedAt           DateTime?
  platformPostId     String?
  error              String?
  metadata           Json?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  metrics            PostMetric[]
  asset              GeneratedAsset   @relation(fields: [assetId], references: [id], onDelete: Cascade)
  socialConnection   SocialConnection @relation(fields: [socialConnectionId], references: [id], onDelete: Cascade)
  user               User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([assetId])
  @@index([socialConnectionId])
  @@index([scheduledFor])
  @@index([status])
  @@map("scheduled_posts")
}

model PostMetric {
  id              String        @id @default(uuid())
  scheduledPostId String
  impressions     Int           @default(0)
  engagements     Int           @default(0)
  likes           Int           @default(0)
  shares          Int           @default(0)
  comments        Int           @default(0)
  clicks          Int           @default(0)
  engagementRate  Float?        @default(0)
  fetchedAt       DateTime      @default(now())
  platform        String
  externalId      String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  scheduledPost   ScheduledPost @relation(fields: [scheduledPostId], references: [id], onDelete: Cascade)

  @@index([scheduledPostId])
  @@index([platform])
  @@index([fetchedAt])
  @@map("post_metrics")
}

model CampaignMetric {
  id                String   @id @default(uuid())
  campaignId        String
  totalPosts        Int      @default(0)
  totalImpressions  Int      @default(0)
  totalEngagements  Int      @default(0)
  avgEngagementRate Float?   @default(0)
  periodStart       DateTime
  periodEnd         DateTime
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  campaign          Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([periodStart, periodEnd])
  @@map("campaign_metrics")
}
